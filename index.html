<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Tiling & Paint Estimator</title>
    <!-- Three.js Library for 3D Rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script> 
    <style>
        /* --- Colors & Global Styles --- */
        :root {
            /* Dark Theme (Default) */
            --primary: #6366f1;           /* Indigo */
            --secondary: #9ca3af;         /* Gray */
            --success: #22c55e;           /* Green */
            --danger: #f97373;            /* Red */
            --warning: #fbbf24;           /* Amber */
            --bg-color: #020617;          /* Page background */
            --card-bg: #020617;           /* Card background base */
            --panel-bg: #0f172a;          /* Inner panel (Slate 900) */
            --border-subtle: #1f2937;     /* Borders */
            --text-main: #e5e7eb;         /* Main text */
            --text-muted: #9ca3af;        /* Muted text */
        }

        /* Light Theme Overrides */
        .light-theme {
            --primary: #4f46e5;           /* Indigo */
            --secondary: #6b7280;         /* Gray */
            --success: #10b981;           /* Green */
            --danger: #ef4444;            /* Red */
            --warning: #f59e0b;           /* Amber */
            --bg-color: #f3f4f6;          /* Page background (Light Gray) */
            --card-bg: #ffffff;           /* Card background base (White) */
            --panel-bg: #f9fafb;          /* Inner panel (Off White) */
            --border-subtle: #d1d5db;     /* Borders (Light Gray) */
            --text-main: #1f2937;         /* Main text (Dark Gray) */
            --text-muted: #6b7280;        /* Muted text (Gray) */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
            margin: 0;
            padding: 10px; 
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1000px;
            margin: 10px auto 30px;
            background: var(--panel-bg);
            padding: 20px; 
            border-radius: 18px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            border: 1px solid var(--border-subtle);
            transition: all 0.3s;
        }

        h1 { font-size: 2.3em; margin-bottom: 15px; }
        h2 { font-size: 1.4em; margin-bottom: 10px; }
        h1, h2 { text-align: center; color: var(--primary); }

        .input-group, .result-display, .suggestion-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            background: var(--panel-bg);
            transition: all 0.3s ease;
        }
        
        /* Data display uses panel background */
        .data-display {
            display: flex; 
            justify-content: space-around; 
            text-align: center;
            background: var(--panel-bg);
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
        }

        /* --- Data Display --- */
        .data-box { 
            padding: 8px; 
            flex-basis: 25%;
            border-right: 1px solid var(--border-subtle);
        }
        .data-box:last-child {
            border-right: none;
        }
        .data-label { 
            font-size: 0.85em; 
            color: var(--text-muted); 
            font-weight: 500; 
        }
        .data-value { 
            font-size: 1.5em; 
            font-weight: 700; 
            color: var(--primary); 
        }
        .live-distance { 
            font-size: 2.3em !important; 
            color: var(--danger); 
        }

        /* --- Buttons, Forms, Grids --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

        .btn {
            display: inline-flex; 
            justify-content: center;
            align-items: center;
            width: 100%; 
            padding: 12px 18px; 
            margin-top: 10px; 
            border: none; 
            border-radius: 999px; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--success));
            color: white; 
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.6);
        }

        .btn-warning { 
            background: linear-gradient(135deg, #f97316, #facc15); 
            color: #111827; 
        }
        .btn-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 30px rgba(249, 115, 22, 0.6);
        }

        .btn:disabled { 
            background: var(--secondary); 
            opacity: 0.6; 
            box-shadow: none;
            cursor: not-allowed;
        }

        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500; 
            color: var(--text-main); 
            font-size: 0.95rem;
        }

        input[type="number"], input[type="color"], select {
            width: 100%; 
            padding: 9px 11px; 
            margin-bottom: 12px; 
            border: 1px solid var(--border-subtle); 
            border-radius: 10px; 
            background-color: var(--card-bg);
            color: var(--text-main); 
            box-sizing: border-box;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s, background-color 0.2s;
        }
        input[type="number"]:focus, input[type="color"]:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.5);
        }

        input[type="color"] { height: 40px; padding: 2px; }

        select {
            appearance: none;
            background-image: linear-gradient(45deg, transparent 50%, var(--text-muted) 50%), 
                              linear-gradient(135deg, var(--text-muted) 50%, transparent 50%);
            background-position: calc(100% - 18px) calc(50% - 4px), calc(100% - 12px) calc(50% - 4px);
            background-size: 6px 6px, 6px 6px;
            background-repeat: no-repeat;
        }

        /* Tile preset buttons */
        .tile-preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        .btn-tile {
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: var(--panel-bg);
            color: var(--text-main);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .btn-tile:hover {
            background: var(--card-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* --- 3D Visualization Specifics --- */
        #visualization-container {
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            height: 340px; 
            margin-bottom: 20px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; 
            background: var(--panel-bg);
            transition: background 0.3s;
        }
        
        /* Overlay for 3D Labels */
        #label-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; 
        }
        .dim-label {
            position: absolute;
            background: var(--panel-bg);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 0.8em;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
        }

        /* --- Results Panel --- */
        .result-item { 
            padding: 15px; 
            border-left: 4px solid var(--success); 
            border-radius: 10px; 
            background: var(--card-bg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            transition: background 0.3s;
        }

        /* --- Status & Source Labels --- */
        #connect-status, #source-status { 
            padding: 12px; 
            border-radius: 999px; 
            font-weight: 600; 
            font-size: 0.95em; 
            text-align: center;
            transition: all 0.3s;
        }
        #source-status {
            margin-bottom: 20px;
        }
        .status-disconnected { 
            background-color: rgba(248, 113, 113, 0.15); 
            color: var(--danger); 
            border: 1px solid rgba(248, 113, 113, 0.5);
        }
        .status-connected { 
            background-color: rgba(22, 163, 74, 0.15); 
            color: var(--success); 
            border: 1px solid rgba(22, 163, 74, 0.6);
        }
        .source-live { 
            background-color: rgba(37, 99, 235, 0.15); 
            color: var(--primary); 
            border: 1px solid rgba(37, 99, 235, 0.6);
        }
        .source-manual { 
            background-color: rgba(250, 204, 21, 0.08); 
            color: var(--warning); 
            border: 1px solid rgba(250, 204, 21, 0.5);
        }

        /* New Top Bar styles */
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        #connect-status {
            margin: 0;
            flex-grow: 1;
            margin-right: 10px;
        }
        .theme-toggle {
            padding: 8px 15px;
            border-radius: 999px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            background: var(--panel-bg);
            color: var(--text-main);
            transition: all 0.2s;
            white-space: nowrap;
        }
        .theme-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Supplier list link style */
        .suggestion-group a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }
        .suggestion-group a:hover {
            color: var(--success);
            text-decoration: underline;
        }
        
        /* --- MODAL STYLES --- */
        #result-modal {
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.85);
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
        }
        .modal-content {
            background: radial-gradient(circle at top, #1f2937, #020617);
            padding: 32px; 
            border-radius: 18px; 
            max-width: 90%; 
            width: 520px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.9); 
            text-align: center; 
            transform: scale(0.7); 
            opacity: 0;
            border: 1px solid #1e293b;
            transition: transform 0.35s cubic-bezier(0.68, -0.55, 0.27, 1.35), opacity 0.25s;
        }
        .modal-content.visible {
            transform: scale(1);
            opacity: 1;
        }
        .modal-close-btn {
            margin-top: 20px;
            padding: 10px 20px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #0f172a;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-value {
            font-size: 2em;
            margin-top: 10px;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media screen and (max-width: 650px) {
            .container { 
                padding: 15px; 
                border-radius: 0; 
            }
            .grid, .grid-3, .grid-4 { 
                grid-template-columns: 1fr; 
                gap: 15px; 
            }
            .data-display { 
                flex-wrap: wrap; 
            }
            .data-box { 
                flex-basis: 45%; 
                margin-bottom: 10px; 
                border-right: none; 
            }
            .data-box:nth-child(2n+1) { 
                 border-right: 1px solid var(--border-subtle);
            }
            #visualization-container { 
                height: 260px; 
            }
            .top-controls {
                flex-direction: column-reverse;
                align-items: stretch;
            }
            #connect-status {
                margin-right: 0;
                margin-top: 10px;
            }
            .theme-toggle {
                flex-grow: 1;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìê IoT Tiling & Paint Estimator (India)</h1>

    <!-- TOP CONTROL BAR: Connection Status and Theme Toggle -->
    <div class="top-controls">
        <div id="connect-status" class="status-disconnected">‚ùå Disconnected from Device</div>
        <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">
            ‚òÄÔ∏è Switch to Light Theme
        </button>
    </div>
    <!-- END TOP CONTROL BAR -->

    <div id="source-status" class="source-manual">Using MANUAL dimensions for calculation</div>

    <!-- Live Data Display -->
    <div class="data-display">
        <div class="data-box">
            <div class="data-label">Last Reading (m)</div>
            <div class="data-value live-distance" id="live-distance">0.00</div>
        </div>
        <div class="data-box">
            <div class="data-label">Length (L) m</div>
            <div class="data-value" id="current-length">0.00</div>
        </div>
        <div class="data-box">
            <div class="data-label">Breadth (B) m</div>
            <div class="data-value" id="current-breadth">0.00</div>
        </div>
        <div class="data-box">
            <div class="data-label">Height (H) m</div>
            <div class="data-value" id="current-height">3.00</div>
        </div>
    </div>
    
    <!-- 3D Visualization & Paint Inputs -->
    <div class="input-group">
        <h2>üé® 3D Room Visualization & Paint Estimator</h2>
        <div id="visualization-container">
            <!-- 3D Labels Overlay -->
            <div id="label-overlay">
                <div id="label-l" class="dim-label">L: 0.00 m</div>
                <div id="label-b" class="dim-label">B: 0.00 m</div>
                <div id="label-h" class="dim-label">H: 0.00 m</div>
            </div>
        </div>
        <div class="grid">
            <div class="input-group">
                <label for="room-height">Room Height (H) in meters:</label>
                <input type="number" id="room-height" value="3.0" step="0.1" onchange="handleHeightChange()">
                <p style="font-size:0.8em; color:var(--text-muted); margin-top: -4px;">Sets height for all calculations.</p>
            </div>
            <div class="input-group">
                <label for="paint-color">Wall Paint Color:</label>
                <input type="color" id="paint-color" value="#4F46E5" onchange="update3DColor()">
                <label for="paint-cost" style="margin-top:6px;">Paint Cost (‚Çπ per litre):</label>
                <input type="number" id="paint-cost" value="450" step="10" onchange="calculateResults(true)">
            </div>
        </div>
    </div>

    <!-- Connection & Manual Input Section -->
    <div class="input-group">
        <div class="grid">
            <div id="ble-connection-section">
                <h2>üîó Bluetooth Connection</h2>
                <p style="font-size:0.8em; color:var(--danger); margin-top:-4px;">Web Bluetooth requires HTTPS and a compatible browser (Chrome / Edge).</p>
                <button class="btn btn-primary" id="btn-connect" onclick="connectToBLE()">Connect to Distance Streamer</button>
            </div>
            <div id="manual-entry-section">
                <h2>üìù Manual Dimension Entry</h2>
                <label for="manual-length">Manual Length (m):</label>
                <input type="number" id="manual-length" value="4.0" step="0.01" onchange="updateManualDimensions('L')">
                <label for="manual-breadth">Manual Breadth (m):</label>
                <input type="number" id="manual-breadth" value="3.0" step="0.01" onchange="updateManualDimensions('B')">
                <label for="manual-height">Manual Height (m):</label>
                <input type="number" id="manual-height" value="3.0" step="0.01" onchange="updateManualDimensions('H')">
            </div>
        </div>
        <button class="btn btn-warning" onclick="toggleMeasurementSource()">Toggle Source (Currently: <span id="source-toggle-text">Manual</span>)</button>
    </div>

    <!-- Measurement Buttons -->
    <div class="input-group grid-3" id="live-measurement-section" style="display:none;">
        <div style="text-align: center;">
            <h2>üìè Measure Length (L)</h2>
            <p id="length-status" style="font-size:0.8em; color:var(--text-muted);">Hold device steady for 5s.</p>
            <button class="btn btn-primary" id="btn-length" onclick="startMeasurement('length')" disabled>
                Capture L (5s Hold)
            </button>
        </div>
        <div style="text-align: center;">
            <h2>üìê Measure Breadth (B)</h2>
            <p id="breadth-status" style="font-size:0.8em; color:var(--text-muted);">Hold device steady for 5s.</p>
            <button class="btn btn-primary" id="btn-breadth" onclick="startMeasurement('breadth')" disabled>
                Capture B (5s Hold)
            </button>
        </div>
        <div style="text-align: center;">
            <h2>‚¨ÜÔ∏è Measure Height (H)</h2>
            <p id="height-status" style="font-size:0.8em; color:var(--text-muted);">Hold device steady for 5s.</p>
            <button class="btn btn-primary" id="btn-height" onclick="startMeasurement('height')" disabled>
                Capture H (5s Hold)
            </button>
        </div>
    </div>

    <!-- Tiling Specifications -->
    <div class="input-group">
        <h2>üß± Tile Specifications & Cost</h2>
        
        <h3 style="font-size:0.95rem; color:var(--text-muted); text-align:left;">Tile Size Suggestions (m)</h3>
        <div class="tile-preset-buttons">
            <button class="btn-tile" onclick="applyTilePreset(0.3, 0.3)">30 √ó 30 cm</button>
            <button class="btn-tile" onclick="applyTilePreset(0.6, 0.6)">60 √ó 60 cm</button>
            <button class="btn-tile" onclick="applyTilePreset(0.8, 1.2)">80 √ó 120 cm (Slab)</button>
        </div>
        
        <div class="grid grid-4">
            <div>
                <label for="tile-length">Tile Length (m):</label>
                <input type="number" id="tile-length" value="0.6" step="0.01" onchange="calculateResults(true)">
            </div>
            <div>
                <label for="tile-breadth">Tile Breadth (m):</label>
                <input type="number" id="tile-breadth" value="0.6" step="0.01" onchange="calculateResults(true)">
            </div>
            <div>
                <label for="cost-per-tile">Cost Per Tile (‚Çπ):</label>
                <input type="number" id="cost-per-tile" value="50" step="1" onchange="calculateResults(true)">
            </div>
            <div>
                <label for="tile-pattern">Tile Pattern:</label>
                <select id="tile-pattern" onchange="calculateResults(true)">
                    <option value="Straight Lay">Straight Lay (5% wastage)</option>
                    <option value="Diagonal">Diagonal (10% wastage)</option>
                    <option value="Herringbone">Herringbone (15% wastage)</option>
                    <option value="Brick">Brick (8% wastage)</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Final Results -->
    <div class="result-display">
        <h2>üìä Final Tiling & Paint Estimate</h2>
        <div class="grid">
            <div class="result-item">
                <h3>Tiles Required (Pcs)</h3>
                <div class="result-value" id="result-tiles">0</div>
                <div class="result-sub-value tile-cost" id="result-tile-cost">‚Çπ0.00 (Tile Cost)</div>
                <div class="result-sub-value" id="wastage-used"></div>
            </div>
            <div class="result-item">
                <h3>Paint Required (Litres)</h3>
                <div class="result-value paint-liters" id="result-paint-liters">0.00 L</div>
                <div class="result-sub-value paint-cost" id="result-paint-cost">‚Çπ0.00 (Total Paint Cost)</div>
            </div>
            <div class="result-item">
                <h3>Floor Area (sq. m)</h3>
                <div class="result-value" id="result-area">0.00</div>
            </div>
            <div class="result-item">
                <h3>Wall Area (sq. m)</h3>
                <div class="result-value" id="result-wall-area">0.00</div>
            </div>
        </div>
    </div>
    
    <!-- Supplier Suggestions (India) -->
    <div class="suggestion-group">
        <h2>üõçÔ∏è Supplier Suggestions (India)</h2>
        <div class="grid">
            <div>
                <h3>Tile Brands</h3>
                <ul>
                    <li><a href="https://www.kajariaceramics.com/" target="_blank">Kajaria Ceramics</a></li>
                    <li><a href="https://www.somanyceramics.com/" target="_blank">Somany Ceramics</a></li>
                    <li><a href="https://aglasiangranito.com/" target="_blank">Asian Granito India (AGL)</a></li>
                </ul>
            </div>
            <div>
                <h3>Paint Brands</h3>
                <ul>
                    <li><a href="https://www.asianpaints.com/" target="_blank">Asian Paints</a></li>
                    <li><a href="https://www.bergerpaints.com/" target="_blank">Berger Paints</a></li>
                    <li><a href="https://www.nerolac.com/" target="_blank">Nerolac Paints</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- FINAL RESULT MODAL POPUP -->
    <div id="result-modal">
        <div class="modal-content">
            <h3>‚ú® Tiling & Paint Plan Complete!</h3>
            <p class="modal-summary">Room Dimensions: <span id="modal-dimensions">0.00m √ó 0.00m √ó 0.00m</span></p>
            <p class="modal-summary">Tiles: <span id="modal-tiles-summary">0 tiles (‚Çπ0.00)</span></p>
            <p class="modal-summary">Paint: <span id="modal-paint-summary">0.00 L (‚Çπ0.00)</span></p>
            <hr>
            <p style="font-size: 1.05em; font-weight: 600; margin-top: 10px;">Estimated Total Material Cost</p>
            <div class="modal-value" id="modal-cost">‚Çπ0.00</div>
            <p style="margin-top: 12px; font-size: 0.85em; color: var(--text-muted);">*Approximate cost for tiles + paint only. Labour and margin not included.</p>
            <button class="modal-close-btn" onclick="hideResultModal()">Close Dashboard</button>
        </div>
    </div>

    <audio id="audio-success" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhAAAACgAAAAAAAAA="></audio>
</div>

<script>
    // --- BLE UUIDs (MUST MATCH ESP32 CODE) ---
    const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
    const DISTANCE_CHAR_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
    const CONTROL_CHAR_UUID = '6d1c810a-428a-449e-b816-b8c7e9142f32';

    // --- STATE VARIABLES ---
    let bleDevice;
    let distanceCharacteristic;
    let controlCharacteristic;
    let currentMeasurementType = null;      // 'length' | 'breadth' | 'height' | null
    let waitingForFinalMeasurement = false; // true after sending 'M'
    let liveDimensions = { L: 0, B: 0, H: 3.0 }; 
    let manualDimensions = { L: 4.0, B: 3.0, H: 3.0 }; 
    let measurementSource = 'manual'; 
    const TILE_PATTERNS = { 'Straight Lay': 0.05, 'Diagonal': 0.10, 'Herringbone': 0.15, 'Brick': 0.08 };
    const PAINT_COVERAGE_SQM_PER_LITER = 10; 
    
    // --- 3D THREE.JS VARIABLES ---
    let scene, camera, renderer, roomMesh, controls;
    let floorGrid = null;
    const container = document.getElementById('visualization-container');
    let wallMaterial; 

    // --- THEME CONTROL ---
    function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            document.getElementById('theme-toggle').innerHTML = 'üåô Switch to Dark Theme';
        } else {
            document.body.classList.remove('light-theme');
            document.getElementById('theme-toggle').innerHTML = '‚òÄÔ∏è Switch to Light Theme';
        }
    }

    function toggleTheme() {
        const body = document.body;
        body.classList.toggle('light-theme');
        const isLight = body.classList.contains('light-theme');
        
        if (isLight) {
            localStorage.setItem('theme', 'light');
            document.getElementById('theme-toggle').innerHTML = 'üåô Switch to Dark Theme';
        } else {
            localStorage.setItem('theme', 'dark');
            document.getElementById('theme-toggle').innerHTML = '‚òÄÔ∏è Switch to Light Theme';
        }
    }

    // --- UTILITY FUNCTION ---
    function getCurrentDimensions() {
        let L, B, H;
        const H_input = parseFloat(document.getElementById('room-height').value) || 3.0;

        if (measurementSource === 'live') {
            L = liveDimensions.L;
            B = liveDimensions.B;
            H = liveDimensions.H;
        } else {
            L = manualDimensions.L;
            B = manualDimensions.B;
            H = manualDimensions.H;
        }
        
        H = H_input; 
        return { L: L, B: B, H: H };
    }
    
    function handleHeightChange() {
        const newH = parseFloat(document.getElementById('room-height').value) || 3.0;
        manualDimensions.H = newH;
        liveDimensions.H = newH;
        
        updateCurrentDimensionsDisplay();
        calculateResults(true);
        update3DRoomGeometry();
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        loadTheme();
        init3DScene();
        
        const initialH = parseFloat(document.getElementById('room-height').value) || 3.0;
        document.getElementById('manual-height').value = initialH;
        manualDimensions.H = initialH;
        liveDimensions.H = initialH; 
        
        updateManualDimensions('init'); 
        updateCurrentDimensionsDisplay();
        updateSourceUI();
        
        if ('speechSynthesis' in window) {
            speechSynthesis.getVoices();
            speechSynthesis.onvoiceschanged = () => {};
        }
    });
    
    // --- 3D SCENE SETUP ---
    function init3DScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020617);

        camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
        directionalLight.position.set(6, 10, 8);
        scene.add(directionalLight);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.08;
        controls.enablePan = false;
        controls.minPolarAngle = Math.PI / 4;
        controls.maxPolarAngle = Math.PI / 2;
        controls.minDistance = 5;
        controls.maxDistance = 20;

        camera.position.set(8, 6, 8); 
        
        roomMesh = new THREE.Group();
        scene.add(roomMesh);
        
        wallMaterial = new THREE.MeshPhongMaterial({ 
            color: document.getElementById('paint-color').value, 
            side: THREE.BackSide,
            shininess: 30
        });

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        const animate = () => {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            update3DLabels(); 
        };
        animate();
        
        update3DRoomGeometry();
    }
    
    function update3DRoomGeometry() {
        const dims = getCurrentDimensions();
        const L = dims.L;
        const B = dims.B;
        const H = dims.H;

        while (roomMesh.children.length > 0) {
            const child = roomMesh.children[0];
            child.geometry && child.geometry.dispose();
            child.material && child.material.dispose();
            roomMesh.remove(child);
        }

        if (floorGrid) {
            scene.remove(floorGrid);
            floorGrid = null;
        }

        if (L <= 0 || B <= 0 || H <= 0) return;

        const divisions = Math.max(2, Math.round(Math.max(L, B) / 0.5));
        floorGrid = new THREE.GridHelper(Math.max(L, B), divisions, 0x4b5563, 0x1f2937);
        floorGrid.position.set(0, 0, 0);
        scene.add(floorGrid);

        const boxGeometry = new THREE.BoxGeometry(L, H, B);
        const walls = new THREE.Mesh(boxGeometry, wallMaterial);
        walls.position.set(0, H / 2, 0);
        roomMesh.add(walls);
        
        const floorGeometry = new THREE.PlaneGeometry(L, B);
        const floorMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x0f172a,
            side: THREE.DoubleSide,
            metalness: 0.1,
            roughness: 0.9
        });
        
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2; 
        floor.position.set(0, 0.001, 0); 
        roomMesh.add(floor);

        controls.target.set(0, H / 2, 0);
    }
    
    function update3DColor() {
        const color = document.getElementById('paint-color').value;
        wallMaterial.color.set(color);
        calculateResults(true);
    }

    const labelPositions = { L: new THREE.Vector3(), B: new THREE.Vector3(), H: new THREE.Vector3() };

    function update3DLabels() {
        const dims = getCurrentDimensions(); 
        const L = dims.L;
        const B = dims.B;
        const H = dims.H;

        const labelL = document.getElementById('label-l');
        const labelB = document.getElementById('label-b');
        const labelH = document.getElementById('label-h');

        if (!labelL || !labelB || !labelH) return;

        if (L <= 0 || B <= 0 || H <= 0) {
            labelL.style.display = 'none';
            labelB.style.display = 'none';
            labelH.style.display = 'none';
            return;
        }

        labelPositions.L.set(0, 0.01, -B / 2);
        labelPositions.B.set(L / 2, 0.01, 0); 
        labelPositions.H.set(L / 2, H / 2, -B / 2);

        const tempV = new THREE.Vector3();
        const containerRect = container.getBoundingClientRect();
        const containerWidth = containerRect.width;
        const containerHeight = containerRect.height;

        function projectAndMoveLabel(dimChar, pos, text) {
            tempV.copy(pos);
            tempV.project(camera); 

            const el = document.getElementById(`label-${dimChar}`);
            if (!el) return;

            const x = (tempV.x * 0.5 + 0.5) * containerWidth;
            const y = (-tempV.y * 0.5 + 0.5) * containerHeight;

            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            el.textContent = `${dimChar.toUpperCase()}: ${text} m`;
            el.style.display = 'block';
        }

        projectAndMoveLabel('l', labelPositions.L, L.toFixed(2));
        projectAndMoveLabel('b', labelPositions.B, B.toFixed(2));
        projectAndMoveLabel('h', labelPositions.H, H.toFixed(2));
    }
    
    // --- TTS ---
    function speak(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            const indianVoice = voices.find(voice => voice.lang === 'en-IN');
            if (indianVoice) {
                utterance.voice = indianVoice;
            } else {
                utterance.rate = 1.05; 
            }
            speechSynthesis.speak(utterance);
        }
    }

    // --- BLE DISCONNECT HANDLER ---
    function bleDisconnectHandler() {
        document.getElementById('connect-status').textContent = '‚ùå Disconnected from Device';
        document.getElementById('connect-status').className = 'status-disconnected';
        disableLiveButtons(true);
        if (measurementSource === 'live') {
            measurementSource = 'manual';
            updateSourceUI();
        }
        speak("Device disconnected.");
    }

    // --- HANDLE DISTANCE NOTIFICATIONS (REAL + MOCK) ---
    function handleDistanceNotification(event) {
        const value = event.target.value;
        const decoder = new TextDecoder('utf-8');
        const text = decoder.decode(value).trim();
        const distance = parseFloat(text);

        if (isNaN(distance)) {
            console.warn("Received non-numeric distance:", text);
            return;
        }

        document.getElementById('live-distance').textContent = distance.toFixed(2);

        if (currentMeasurementType && waitingForFinalMeasurement) {
            waitingForFinalMeasurement = false;
            finalizeMeasurement(distance);
        }
    }

    // --- CONNECT TO BLE ---
    async function connectToBLE() {
        if (!navigator.bluetooth) {
            const statusEl = document.getElementById('connect-status');
            statusEl.textContent = '‚ùå Web Bluetooth UNAVAILABLE (Using mock data for demo)';
            statusEl.className = 'status-disconnected';
            speak("Web Bluetooth is not supported. Enabling mock connection for testing.");
            
            bleDevice = { gatt: { connected: true }, name: 'Mock Distance Streamer' };
            distanceCharacteristic = {};
            controlCharacteristic = {};

            statusEl.textContent = '‚úÖ Mock Connected (Live Feature Enabled)';
            statusEl.className = 'status-connected';
            disableLiveButtons(false);
            
            if (measurementSource === 'manual') {
                measurementSource = 'live';
                updateSourceUI();
            }

            const encoder = new TextEncoder();
            setInterval(() => {
                const fake = (Math.random() * 2 + 2).toFixed(2); // 2‚Äì4m
                const value = encoder.encode(fake);
                handleDistanceNotification({ target: { value } });
            }, 100); 

            return;
        }

        document.getElementById('connect-status').textContent = 'Searching for device...';
        document.getElementById('connect-status').className = 'status-disconnected';
        speak("Searching for device. Please ensure your device is powered on.");

        try {
            bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'Distance Streamer' }],
                optionalServices: [SERVICE_UUID]
            });
            
            bleDevice.addEventListener('gattserverdisconnected', bleDisconnectHandler);
            const server = await bleDevice.gatt.connect();
            
            const service = await server.getPrimaryService(SERVICE_UUID);
            distanceCharacteristic = await service.getCharacteristic(DISTANCE_CHAR_UUID);
            controlCharacteristic = await service.getCharacteristic(CONTROL_CHAR_UUID);

            await distanceCharacteristic.startNotifications();
            distanceCharacteristic.addEventListener('characteristicvaluechanged', handleDistanceNotification);

            document.getElementById('connect-status').textContent = '‚úÖ Connected to Device';
            document.getElementById('connect-status').className = 'status-connected';
            disableLiveButtons(false);
            
            if (measurementSource === 'manual') {
                measurementSource = 'live';
                updateSourceUI();
            }
            speak("Device connected successfully. Ready to measure.");

        } catch (error) {
            console.error('Bluetooth Connection Error:', error);
            document.getElementById('connect-status').textContent = `‚ùå Connection Failed: ${error.message}`;
            document.getElementById('connect-status').className = 'status-disconnected';
            disableLiveButtons(true);
            speak("Connection failed. Please check device power and refresh.");
        }
    }

    // --- SEND MEASURE COMMAND ('M') ---
    async function sendMeasureCommand() {
        if (!controlCharacteristic || !bleDevice || !bleDevice.gatt || !bleDevice.gatt.connected) {
            console.error("Control characteristic or device connection is invalid.");
            return;
        }

        try {
            const encoder = new TextEncoder();
            waitingForFinalMeasurement = true;
            await controlCharacteristic.writeValue(encoder.encode('M'));
            console.log("Sent 'M' command to ESP32");
        } catch (error) {
            console.error("Error sending measure command:", error);
            waitingForFinalMeasurement = false;
        }
    }
    
    // --- MEASUREMENT LOGIC ---
    const MEASUREMENT_DURATION_SECONDS = 5;
    let countdownIntervalId = null;

    function startMeasurement(type) {
        const isConnected = document.getElementById('connect-status').className.includes('status-connected');

        if (measurementSource !== 'live' || !isConnected) {
            alert("Cannot start: Switch to Live mode and ensure the device is connected.");
            return;
        }
        
        currentMeasurementType = type;
        const statusEl = document.getElementById(`${type}-status`);
        
        disableLiveButtons(true);
        
        let remainingTime = MEASUREMENT_DURATION_SECONDS;
        speak(`Measuring ${type}. Hold the sensor steady.`);
        waitingForFinalMeasurement = false;

        statusEl.textContent = `Holding steady... ${remainingTime}s remaining.`;
        
        countdownIntervalId = setInterval(() => {
            remainingTime--;
            if (remainingTime >= 0) {
                statusEl.textContent = `Holding steady... ${remainingTime}s remaining.`;
            }
            if (remainingTime < 0) {
                clearInterval(countdownIntervalId);
                statusEl.textContent = `Capturing final reading...`;
                sendMeasureCommand();
            }
        }, 1000);
    }

    function finalizeMeasurement(distance) {
        if (!currentMeasurementType) return;
        
        const type = currentMeasurementType;
        const statusEl = document.getElementById(`${type}-status`);
        
        if (distance <= 0.05) {
            statusEl.textContent = "Measurement Failed: Invalid reading received. Distance too small.";
            currentMeasurementType = null;
            disableLiveButtons(false);
            speak(`Measurement failed for ${type}. Try again.`);
            return;
        }
        
        const distanceRounded = distance.toFixed(2);

        if (type === 'length') {
            liveDimensions.L = parseFloat(distanceRounded);
        } else if (type === 'breadth') {
            liveDimensions.B = parseFloat(distanceRounded);
        } else if (type === 'height') {
            liveDimensions.H = parseFloat(distanceRounded);
            document.getElementById('room-height').value = distanceRounded;
            manualDimensions.H = parseFloat(distanceRounded);
        }
        
        statusEl.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} saved: ${distanceRounded} m.`;
        
        updateCurrentDimensionsDisplay();
        const results = calculateResults(true);
        
        if (type === 'length') {
            speak(`Length saved. ${distanceRounded} meters. Please measure the breadth now.`);
        } else if (type === 'breadth') {
            speak(`Breadth saved. ${distanceRounded} meters. Now measure the height.`);
        } else if (type === 'height') {
            if (liveDimensions.L > 0 && liveDimensions.B > 0) {
                speak(`Height saved. All dimensions are ready. Total estimated material cost is ${Math.round(results.totalProjectCost)} rupees.`);
                showResultModal(results);
            } else {
                speak(`Height saved. Please measure length and breadth to complete the estimate.`);
            }
        }
        
        currentMeasurementType = null;
        disableLiveButtons(false);
        update3DRoomGeometry(); 
    }

    // --- UI & STATE CONTROL ---
    function disableLiveButtons(shouldDisable) {
        document.getElementById('btn-length').disabled = shouldDisable;
        document.getElementById('btn-breadth').disabled = shouldDisable;
        document.getElementById('btn-height').disabled = shouldDisable;
    }

    function updateSourceUI() {
        const liveSection = document.getElementById('live-measurement-section');
        if (measurementSource === 'manual') {
            document.getElementById('source-toggle-text').textContent = 'Manual';
            document.getElementById('source-status').textContent = 'Using MANUAL dimensions for calculation';
            document.getElementById('source-status').className = 'source-manual';
            liveSection.style.display = 'none';
        } else {
            document.getElementById('source-toggle-text').textContent = 'Live BLE';
            document.getElementById('source-status').textContent = 'Using LIVE BLE data for calculation';
            document.getElementById('source-status').className = 'source-live';
            liveSection.style.display = 'grid';
            const isConnected = document.getElementById('connect-status').className.includes('status-connected');
            disableLiveButtons(!isConnected);
        }
        updateCurrentDimensionsDisplay();
        calculateResults(true);
        update3DRoomGeometry();
    }

    function toggleMeasurementSource() {
        if (measurementSource === 'manual') {
            const isConnected = document.getElementById('connect-status').className.includes('status-connected');

            if (isConnected) {
                measurementSource = 'live';
                speak("Switched to Live Data mode.");
            } else {
                alert("Cannot switch to Live Data: Device is not connected. Please connect first using the 'Connect' button.");
                return;
            }
        } else {
            measurementSource = 'manual';
            speak("Switched back to Manual Entry mode.");
        }
        updateSourceUI();
    }

    function updateManualDimensions(dim = 'init') {
        const mL = parseFloat(document.getElementById('manual-length').value) || 0;
        const mB = parseFloat(document.getElementById('manual-breadth').value) || 0;
        const mH = parseFloat(document.getElementById('manual-height').value) || 0;
        
        manualDimensions.L = mL;
        manualDimensions.B = mB;
        manualDimensions.H = mH;

        if (dim === 'H' || dim === 'init') {
            document.getElementById('room-height').value = mH.toFixed(2);
            liveDimensions.H = mH;
        }

        if (measurementSource === 'manual' || dim === 'init') {
            updateCurrentDimensionsDisplay();
            calculateResults(true);
            update3DRoomGeometry();
        }
    }

    function updateCurrentDimensionsDisplay() {
        const dims = getCurrentDimensions();
        
        document.getElementById('current-length').textContent = dims.L.toFixed(2);
        document.getElementById('current-breadth').textContent = dims.B.toFixed(2);
        document.getElementById('current-height').textContent = dims.H.toFixed(2);
    }
    
    function applyTilePreset(L, B) {
        document.getElementById('tile-length').value = L.toFixed(2);
        document.getElementById('tile-breadth').value = B.toFixed(2);
        calculateResults(true);
    }

    function formatRupees(amount) {
        return `‚Çπ${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // --- CALCULATION LOGIC ---
    function calculateResults(updateUI = false) {
        const dims = getCurrentDimensions();
        const L = dims.L;
        const B = dims.B;
        const H = dims.H;

        const patternName = document.getElementById('tile-pattern').value;
        const patternWastage = TILE_PATTERNS[patternName] || 0.05;
        const tileL = parseFloat(document.getElementById('tile-length').value) || 0;
        const tileB = parseFloat(document.getElementById('tile-breadth').value) || 0;
        const costPerTile = parseFloat(document.getElementById('cost-per-tile').value) || 0;
        const costPerLitre = parseFloat(document.getElementById('paint-cost').value) || 0;
        const wastage = patternWastage; 
        
        let areaRoom = 0;
        let wallArea = 0;
        let tilesRequired = 0;
        let totalTileCost = 0;
        let paintLiters = 0;
        let totalPaintCost = 0;

        if (L > 0 && B > 0 && H > 0 && tileL > 0 && tileB > 0) {
            areaRoom = L * B;
            const areaTile = tileL * tileB;
            if (areaTile > 0) {
                const tilesNeededRaw = areaRoom / areaTile;
                tilesRequired = Math.ceil(tilesNeededRaw * (1 + wastage));
                totalTileCost = tilesRequired * costPerTile;
            }
            
            const perimeter = 2 * (L + B);
            wallArea = (perimeter * H) + areaRoom;
            paintLiters = wallArea / PAINT_COVERAGE_SQM_PER_LITER;
            totalPaintCost = paintLiters * costPerLitre;
        }
        
        const results = {
            L, B, H, 
            areaRoom, wallArea,
            tilesRequired, totalTileCost,
            paintLiters, totalPaintCost,
            patternName, wastage,
            totalProjectCost: totalTileCost + totalPaintCost
        };

        if (updateUI) {
            document.getElementById('result-area').textContent = results.areaRoom.toFixed(2);
            document.getElementById('result-wall-area').textContent = results.wallArea.toFixed(2);
            document.getElementById('result-tiles').textContent = results.tilesRequired;
            document.getElementById('result-tile-cost').textContent = `${formatRupees(results.totalTileCost)} (Tile Cost)`;
            document.getElementById('wastage-used').textContent = `Wastage used: ${Math.round(results.wastage * 100)}% (${results.patternName} pattern)`;
            document.getElementById('result-paint-liters').textContent = `${results.paintLiters.toFixed(2)} L`;
            document.getElementById('result-paint-cost').textContent = `${formatRupees(results.totalPaintCost)} (Total Paint Cost)`;
            update3DRoomGeometry(); 
        }

        return results;
    }

    // --- MODAL LOGIC ---
    function showResultModal(results) {
        document.getElementById('modal-dimensions').textContent = `${results.L.toFixed(2)}m √ó ${results.B.toFixed(2)}m √ó ${results.H.toFixed(2)}m`;
        document.getElementById('modal-tiles-summary').textContent = `${results.tilesRequired} pcs (${formatRupees(results.totalTileCost)})`;
        document.getElementById('modal-paint-summary').textContent = `${results.paintLiters.toFixed(2)} L (${formatRupees(results.totalPaintCost)})`;
        document.getElementById('modal-cost').textContent = formatRupees(results.totalProjectCost);

        const modal = document.getElementById('result-modal');
        const content = modal.querySelector('.modal-content');
        modal.style.display = 'flex';
        setTimeout(() => content.classList.add('visible'), 10);
    }

    function hideResultModal() {
        const modal = document.getElementById('result-modal');
        const content = modal.querySelector('.modal-content');
        content.classList.remove('visible');
        setTimeout(() => modal.style.display = 'none', 250);
    }
</script>

</body>
</html>
